---
description: Agents Rule of Two – AI 에이전트 보안 프레임워크 기반 설계 규칙
globs:
  - "**/*.{ts,tsx,js,jsx,py,md}"
alwaysApply: true
---

# Agents Rule of Two 규칙

AI 에이전트를 설계하거나 구현할 때, **Meta의 Agents Rule of Two** 프레임워크를 따라야 합니다.

## 핵심 원칙

에이전트는 다음 세 가지 속성 중 **최대 두 가지만** 동시에 가져야 합니다:

- **[A] Untrustworthy Inputs (신뢰할 수 없는 입력)**: 알 수 없는 출처의 데이터를 처리할 수 있는지 여부
- **[B] Sensitive Systems or Private Data (민감한 시스템 또는 개인 데이터)**: 민감한 정보나 시스템에 접근할 수 있는지 여부
- **[C] State Changes or External Communication (상태 변경 또는 외부 통신)**: 시스템 상태를 변경하거나 외부와 통신할 수 있는지 여부

## 필수 규칙

### 1. 구성 선택

에이전트 설계 시 다음 중 하나를 선택합니다:

- **[AB]**: 신뢰할 수 없는 입력 + 민감한 데이터 접근 (외부 통신/상태 변경 제한)
- **[AC]**: 신뢰할 수 없는 입력 + 외부 통신/상태 변경 (민감한 데이터 접근 제한)
- **[BC]**: 민감한 데이터 접근 + 외부 통신/상태 변경 (신뢰할 수 없는 입력 제한)

### 2. 세 가지가 모두 필요한 경우

세 가지 속성 [A], [B], [C]가 모두 필요한 경우:

- **새로운 세션(새로운 컨텍스트 윈도우)**을 시작하거나
- **인간 감독(human-in-the-loop)** 또는 **다른 신뢰할 수 있는 검증 수단**을 도입해야 합니다.

### 3. 세션 내 구성 전환

에이전트가 동일한 세션 내에서 하나의 구성에서 다른 구성으로 전환하는 경우:

- **공격 경로를 방해**하는 것에 집중합니다.
- [A] → [B] → [C]의 전체 체인을 완성하지 못하도록 공격을 방지합니다.
- 예: [AC]로 시작하여 인터넷에 접근하고, 내부 시스템에 접근할 때 통신을 비활성화하여 [B]로 일방향 전환

## 구현 가이드라인

### [AB] 구성 예시: Travel Agent Assistant

- [A] 웹 검색을 통해 최신 여행 정보를 얻음
- [B] 사용자 개인정보에 접근하여 예약 및 구매 경험 제공
- [C] 제한: 모든 행동(예약, 보증금 지불 등)에 대해 인간 확인 요청, 웹 요청을 신뢰할 수 있는 소스에서만 반환된 URL로 제한

### [AC] 구성 예시: Web Browsing Research Assistant

- [A] 임의의 URL 결과를 처리하고 필요에 따라 재계획
- [C] 많은 요청을 보내고 폼을 작성
- [B] 제한: 제한적인 샌드박스에서 브라우저 실행, 사전 로드된 세션 데이터 없음, 개인정보 접근 제한

### [BC] 구성 예시: High-Velocity Internal Coder

- [B] 프로덕션 시스템의 하위 집합에 접근
- [C] 시스템에 대한 상태 변경 수행
- [A] 제한: 작성자 계보(author-lineage)를 사용하여 모든 데이터 소스 필터링, 인간 검토 프로세스 제공

## 금지사항

- 세 가지 속성 [A], [B], [C]를 **동시에 모두** 허용하지 않습니다 (새 세션 또는 인간 감독 없이).
- Agents Rule of Two를 만족한다고 해서 **다른 보안 원칙을 무시**하지 않습니다.
  - 최소 권한(least-privilege) 원칙 등은 계속 적용해야 합니다.
- **방어 심층(Defense in Depth)**을 고려하지 않으면 안 됩니다.
  - 단일 계층의 실패가 가능할 때를 대비해 여러 보안 계층을 구축합니다.

## 제한사항 인지

Agents Rule of Two를 만족하는 것이 다음을 보호하기에 **충분하지 않습니다**:

- 다른 위협 벡터 (공격자 승격, 스팸 확산, 에이전트 실수, 환각, 과도한 권한 등)
- Prompt injection의 낮은 영향 결과 (에이전트 응답의 오정보 등)

## 코드 작성 시 체크리스트

에이전트 코드를 작성하거나 리뷰할 때:

1. 에이전트가 처리하는 입력의 신뢰성을 평가합니다.
2. 에이전트가 접근하는 데이터나 시스템의 민감성을 평가합니다.
3. 에이전트가 수행하는 상태 변경이나 외부 통신을 식별합니다.
4. 세 가지 속성 중 몇 개가 활성화되어 있는지 확인합니다.
5. 세 가지가 모두 활성화된 경우, 새로운 세션 또는 인간 감독 메커니즘을 도입합니다.
6. 선택한 구성([AB], [AC], 또는 [BC])에 맞는 제한 조치를 구현합니다.

## 예시: Email-Bot 방어

**공격 시나리오**: 스팸 이메일에 prompt injection이 포함되어 사용자의 이메일함 내용을 공격자에게 전송

**방어 방법**:

- **[BC] 구성**: 신뢰할 수 있는 발신자(예: 가까운 친구)의 이메일만 처리
- **[AC] 구성**: 민감한 데이터나 시스템에 접근하지 않도록 제한 (테스트 환경에서만 작동)
- **[AB] 구성**: 신뢰할 수 있는 수신자에게만 이메일을 전송하거나, 인간이 초안 메시지 내용을 검증

## 참고

- 이 규칙은 `meta-agents-rule/AGENTS.md` 문서를 기반으로 합니다.
- 자세한 내용과 예시는 해당 문서를 참조하세요.
